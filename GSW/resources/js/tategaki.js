function _ff80d4a6f06d93580f7ab015ef6908db1ca205dc(){};(function(){var a;a=(function(){function b(d,c){if(c==null){c={}}this.iframeId=d;this.colNum=c.colNum||10;this.colWidth=c.colWidth||15;this.render()}b.prototype.on=function(c,d){if(!this.eventListeners){this.eventListeners={}}if(!this.eventListeners.hasOwnProperty(c)){this.eventListeners[c]=[]}return this.eventListeners[c].push(d)};b.prototype.fireEvent=function(g,f){var k,j,i,d,h,c;if(this.eventListeners.hasOwnProperty(g)){h=this.eventListeners[g];c=[];for(i=0,d=h.length;i<d;i++){j=h[i];c.push(j.call(null,f))}return c}};b.prototype.render=function(){var c;this.doc=document.getElementById(this.iframeId).contentWindow.document;this.head=$("head",this.doc);this.body=$("body",this.doc);c=$('<link rel="stylesheet" type="text/css" href="resources/css/tategaki.css"/>');this.editor=$('<div contenteditable class="tategaki-editor" widht="100%" height="100%"></div>').height(this.body.height());this.head.append(c);this.body.append(this.editor);this.editor.resize((function(d){return function(f){return console.log(f)}})(this));return this.bindKeyEventHandlers()};b.prototype.bindKeyEventHandlers=function(){this.editor.on("keydown",(function(c){return function(d){switch(d.keyCode){case 38:c.movecarettoprevchar();d.stopPropagation();return d.preventDefault();case 40:c.moveCaretToNextChar();d.stopPropagation();return d.preventDefault();case 37:c.moveCaretToNextLine();d.stopPropagation();return d.preventDefault();case 39:c.moveCaretToPrevLine();d.stopPropagation();return d.preventDefault()}}})(this));this.editor.on("keyup",(function(c){return function(d){return c.fireEvent("change",d)}})(this));this.editor.on("keydown click focus",(function(c){return function(){return c.highlightSelected()}})(this));this.editor.on("contextmenu",(function(c){return function(d){return c.fireEvent("contextmenu",d)}})(this));return this.editor.on("mousedown",(function(c){return function(d){return c.fireEvent("mousedown",d)}})(this))};b.prototype.highlightSelected=function(){this.resetElementSelection();this.selected=$(this.selectedElement());if(!this.selected.hasClass("tategaki-column")){this.selected.addClass("selected")}return this.fireEvent("element:selected",this.selectedElement())};b.prototype.getHtmlSource=function(){return $(this.editor).html()};b.prototype.markup=function(f,k){var h,j,l,g,c,d;if(k==null){k={}}c=this.doc.getSelection();g=c.getRangeAt(0);if(g.collapsed){return}l=this.doc.createElement(f);for(j in k){d=k[j];l.setAttribute(j,d)}try{g.surroundContents(l);c.removeAllRanges();return c.addRange(g)}catch(i){h=i;console.log(h);throw"selection not markupable"}};b.prototype.makeLink=function(c){return this.markup("a",{href:c})};b.prototype.ruby=function(h,j){var k,g,i,f,e,c,d;if(j==null){j={}}c=this.doc.getSelection();f=c.getRangeAt(0);if(f.collapsed){return}e=this.doc.createElement("ruby");console.log(f);f.surroundContents(e);g=this.doc.createTextNode(h);k=this.doc.createElement("rt");k.appendChild(g);e.appendChild(k);for(i in j){d=j[i];e.setAttribute(i,d)}c.removeAllRanges();return c.addRange(f)};b.prototype.removeMarkup=function(){if(this.selected.hasClass("tategaki-column")){return null}this.selected.contents().unwrap();return this.selected=null};b.prototype.moveCaretToNextLine=function(){var e,d,f,c,h;if(!(e=this.nextColumn())){return}c=e.offsetLeft+e.offsetWidth/2;h=this.getCaretCoordinates().top;try{f=this.doc.getSelection();d=this.doc.caretRangeFromPoint(c,h);f.removeAllRanges();return f.addRange(d)}catch(g){}};b.prototype.moveCaretToPrevLine=function(){var e,d,f,c,h;if(!(e=this.prevColumn())){return}c=e.offsetLeft+e.offsetWidth/2;h=this.getCaretCoordinates().top;try{f=this.doc.getSelection();d=this.doc.caretRangeFromPoint(c,h);f.removeAllRanges();return f.addRange(d)}catch(g){}};b.prototype.getCaretCoordinates=function(){var f,c,d,e;d=this.doc.getSelection().getRangeAt(0).cloneRange();e=$("<span></span>");d.insertNode(e[0]);c=$(e).offset();f=e[0].parentNode;f.removeChild(e[0]);f.normalize();return c};b.prototype.moveCaretToNextChar=function(){var e,c,d,f;if(!this.editor.is(":focus")){return null}d=this.doc.getSelection().getRangeAt(0).cloneRange();f=this.doc.getSelection();e=d.startContainer;if(e.length===d.startOffset){c=this.findNextTextNode(e);if(!c){return}d.setStart(c,0)}else{d.setStart(e,d.startOffset+1)}f.removeAllRanges();return f.addRange(d)};b.prototype.moveCaretToPrevChar=function(){var e,c,d,f;if(!this.editor.is(":focus")){return null}d=this.doc.getSelection().getRangeAt(0).cloneRange();f=this.doc.getSelection();e=d.startContainer;if(d.startOffset===0){c=this.findPrevTextNode(e);if(!c){return}d.setStart(c,c.length);d.setEnd(c,c.length)}else{d.setStart(e,d.startOffset-1);d.setEnd(e,d.endOffset-1)}f.removeAllRanges();return f.addRange(d)};b.prototype.findNextTextNode=function(c){if(c.nextSibling){if(c.nextSibling.nodeType===3){if(c.nextSibling.length>0){return c.nextSibling}else{return this.findNextTextNode(c.nextSibling)}}else{if(c.nextSibling.hasChildNodes()){if(c.nextSibling.firstChild.nodeType===3){return c.nextSibling.firstChild}return this.findNextTextNode(c.nextSibling.firstChild)}}}else{while(!c.parentNode.nextSibling){c=c.parentNode;if(c===this.editor[0]){return null}}return this.findNextTextNode(c.parentNode)}};b.prototype.findPrevTextNode=function(c){if(c.previousSibling){if(c.previousSibling.nodeType===3){if(c.previousSibling.length>0){return c.previousSibling}else{return this.findPrevTextNode(c.previousSibling)}}else{if(c.previousSibling.hasChildNodes()){if(c.previousSibling.lastChild.nodeType===3){return c.previousSibling.lastChild}return this.findPrevTextNode(c.previousSibling.lastChild)}}}else{while(!c.parentNode.previousSibling){c=c.parentNode;if(c===this.editor[0]){return null}}return this.findPrevTextNode(c.parentNode)}};b.prototype.getCaretPosition=function(){var c;if(!this.editor.is(":focus")){return null}c=this.doc.getSelection().getRangeAt(0);return{el:c.startContainer,offset:c.startOffset}};b.prototype.setCaretPosition=function(d,f){var c,e;if(!this.editor.is(":focus")){return null}c=this.doc.createRange();e=this.doc.getSelection();c.setStart(this.editor[0].childNodes[d],f);c.collapse(true);e.removeAllRanges();return e.addRange(c)};b.prototype.prevColumn=function(){var c;if(c=this.currentColumn()){return c.previousSibling}else{return null}};b.prototype.nextColumn=function(){var c;if(c=this.currentColumn()){return c.nextSibling}else{return null}};b.prototype.currentColumn=function(){var c,d;if(!this.editor.is(":focus")){return null}if(!(c=this.doc.getSelection().focusNode)){return null}console.log(c);if(c.nodeType===1){d=c}else{d=c.parentElement}while(!$(d).hasClass("tategaki-column")){d=d.parentElement}return d};b.prototype.selectedElement=function(){var d,c;if(!this.editor.is(":focus")){return null}c=this.doc.getSelection().focusNode;d=c.nodeType===1?c:c.parentElement;return d};b.prototype.resetElementSelection=function(){return this.editor.find(".selected").removeClass("selected")};b.prototype.source=function(c){return this.editor.html(c)};b.prototype.getIframeOffset=function(){return $("#"+this.iframeId).offset()};return b})();window.TategakiEditor=a}).call(this);